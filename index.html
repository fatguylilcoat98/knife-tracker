<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
<title>Accurate Edges - Route Manager</title>

<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Share+Tech+Mono&family=Exo+2:wght@300;400;600;800&display=swap" rel="stylesheet">

<script
  src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBZ33GrowzU4ZyLTodjB7w55XAnqGQm7rM&libraries=places&callback=initPlacesAutocomplete"
  async defer>
</script>

<style>
  :root {
    --bg: #0a0c0f;
    --surface: #111318;
    --surface2: #181b22;
    --surface3: #1e222c;
    --accent: #00e5ff;
    --accent2: #ff6b35;
    --accent3: #39ff14;
    --danger: #ff3d5a;
    --text: #d8dde8;
    --text-dim: #6b7280;
    --border: rgba(192,200,216,0.12);
    --glow: 0 0 20px rgba(0,229,255,0.25);
    --glow2: 0 0 20px rgba(255,107,53,0.25);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Exo 2', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background: 
      repeating-linear-gradient(0deg, transparent, transparent 60px, rgba(0,229,255,0.015) 60px, rgba(0,229,255,0.015) 61px),
      repeating-linear-gradient(90deg, transparent, transparent 60px, rgba(0,229,255,0.015) 60px, rgba(0,229,255,0.015) 61px);
    pointer-events: none;
    z-index: 0;
  }

  /* Header */
  .app-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(10,12,15,0.97);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: 0 14px;
  }

  .header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 0 8px;
    gap: 10px;
  }

  .header-logo-block {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
  }

  .header-logo-block img {
    height: 42px;
    width: auto;
    filter: drop-shadow(0 0 8px rgba(0,229,255,0.2));
  }

  .brand-name {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 1.2rem;
    letter-spacing: 2.5px;
    color: var(--accent);
    text-shadow: var(--glow);
  }

  .brand-sub {
    font-family: 'Share Tech Mono', monospace;
    font-size: 0.58rem;
    color: var(--text-dim);
    text-transform: uppercase;
  }

  /* Role Toggle */
  .role-toggle {
    display: flex;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .role-btn {
    padding: 7px 12px;
    border: none;
    background: transparent;
    color: var(--text-dim);
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    font-size: 0.8rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .role-btn.active {
    background: var(--accent);
    color: #000;
  }

  /* Tabs */
  .tab-bar {
    display: flex;
    overflow-x: auto;
    border-top: 1px solid var(--border);
    scrollbar-width: none;
  }

  .tab-btn {
    flex: 0 0 auto;
    padding: 10px 14px;
    border: none;
    background: transparent;
    color: var(--text-dim);
    font-family: 'Rajdhani', sans-serif;
    font-weight: 600;
    font-size: 0.78rem;
    text-transform: uppercase;
    cursor: pointer;
    border-bottom: 2px solid transparent;
  }

  .tab-btn.active {
    color: var(--accent);
    border-bottom-color: var(--accent);
  }

  .tab-btn.hidden { display: none; }

  /* Content */
  #app-content {
    padding: 16px;
    max-width: 700px;
    margin: 0 auto;
    position: relative;
    z-index: 1;
  }

  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 16px;
  }

  .card-title {
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    font-size: 0.75rem;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .card-title::after {
    content: '';
    flex: 1;
    height: 1px;
    background: linear-gradient(90deg, var(--border), transparent);
  }

  /* Forms */
  .form-group { margin-bottom: 12px; }
  label { font-size: 0.72rem; color: var(--text-dim); text-transform: uppercase; display: block; margin-bottom: 4px; }
  input, select, textarea {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    padding: 10px;
    font-family: 'Exo 2', sans-serif;
  }

  /* Buttons */
  .btn {
    width: 100%;
    padding: 12px;
    border-radius: 8px;
    border: none;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700;
    text-transform: uppercase;
    cursor: pointer;
    margin-top: 8px;
  }

  .btn-primary { background: var(--accent); color: #000; box-shadow: var(--glow); }
  .btn-green { background: var(--accent3); color: #000; }
  .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
  .btn-danger { background: var(--danger); color: #fff; }

  /* Dispatch Checklist */
  .dispatch-checklist {
    background: var(--surface2);
    border-radius: 10px;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid var(--border);
  }

  .dispatch-check-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border-bottom: 1px solid var(--border);
  }

  /* Payroll Tiers */
  .payroll-summary {
    background: linear-gradient(135deg, rgba(0,229,255,0.1), rgba(57,255,20,0.05));
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    border: 1px solid var(--border);
  }

  .payroll-check { font-family: 'Share Tech Mono', monospace; font-size: 2.5rem; color: var(--accent3); }

  .tier-row { display: flex; justify-content: space-between; padding: 6px 10px; border-radius: 4px; font-size: 0.8rem; }
  .active-tier { background: rgba(57,255,20,0.2); color: var(--accent3); font-weight: bold; }

  /* Modal */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    z-index: 200;
    padding: 20px;
  }
  .modal-overlay.active { display: flex; align-items: center; justify-content: center; }
  .modal-box { background: var(--surface); border-radius: 16px; width: 100%; max-width: 500px; padding: 20px; border: 1px solid var(--border); }

  /* Utilities */
  .badge { padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; }
  .badge-cod { background: var(--accent2); color: #fff; }
  .badge-cash { background: var(--accent3); color: #000; }
  .badge-ar { background: var(--accent); color: #000; }

  #toast {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface2);
    border: 1px solid var(--accent);
    padding: 10px 20px;
    border-radius: 8px;
    opacity: 0;
    transition: 0.3s;
    z-index: 1000;
  }
  #toast.show { opacity: 1; }
</style>
</head>
<body>

<div class="app-header">
  <div class="header-top">
    <div class="header-logo-block">
      <img src="1771924165353.jpeg" alt="Logo">
      <div>
        <div class="brand-name">ACCURATE EDGES</div>
        <div class="brand-sub">Route Manager</div>
      </div>
    </div>
    <div class="role-toggle">
      <button class="role-btn" id="btnDriver" onclick="setRole('driver')">DRIVER</button>
      <button class="role-btn" id="btnBoss" onclick="setRole('boss')">BOSS</button>
    </div>
  </div>
  <div class="tab-bar">
    <button class="tab-btn hidden" id="tab-dispatch" onclick="showTab('dispatch')">Dispatch</button>
    <button class="tab-btn" id="tab-route" onclick="showTab('route')">Route</button>
    <button class="tab-btn" id="tab-translator" onclick="showTab('translator')">Translate</button>
    <button class="tab-btn" id="tab-roster" onclick="showTab('roster')">Roster</button>
    <button class="tab-btn" id="tab-payroll" onclick="showTab('payroll')">Payroll</button>
  </div>
</div>

<div id="app-content">
  <div class="tab-panel" id="panel-dispatch">
    <div class="card">
      <div class="card-title">Build Today's Route</div>
      <input type="text" id="dispatchSearch" placeholder="Search clients..." oninput="renderDispatchList()" style="margin-bottom:10px;">
      <div class="dispatch-checklist" id="dispatchChecklist"></div>
      <button class="btn btn-primary" onclick="dispatchRoute()">Dispatch Now</button>
    </div>
  </div>

  <div class="tab-panel" id="panel-route">
    <div class="card">
      <div class="card-title">Active Stops</div>
      <div id="liveRouteList"></div>
    </div>
  </div>

  <div class="tab-panel" id="panel-payroll">
    <div class="payroll-summary">
      <div class="brand-sub">Estimated Paycheck</div>
      <div class="payroll-check" id="paycheck">$600.00</div>
      <div id="payrollStats" style="font-size: 0.8rem; color: var(--text-dim); margin-top: 10px;"></div>
    </div>
    <div class="card" style="margin-top:16px;">
      <div class="card-title">Commission Tiers</div>
      <div id="tierTable"></div>
    </div>
  </div>

  <div class="tab-panel" id="panel-roster">
    <div class="card">
        <div class="card-title">Add Client</div>
        <input type="text" id="r_name" placeholder="Business Name">
        <input type="text" id="r_address" placeholder="Address">
        <select id="r_terms">
            <option value="C.O.D.">C.O.D.</option>
            <option value="Cash">Cash</option>
            <option value="AR / On Acct">AR / On Account</option>
        </select>
        <button class="btn btn-primary" onclick="saveClient()">Save Client</button>
    </div>
    <div id="rosterList"></div>
  </div>

  <div class="tab-panel" id="panel-translator">
    <div class="card">
        <div class="card-title">Spanish Translator</div>
        <textarea id="typeInput" placeholder="Type here..."></textarea>
        <button class="btn btn-primary" onclick="translateTyped('en','es')">Translate to Spanish</button>
        <div id="translationDisplay" class="card" style="margin-top:10px; min-height:50px;"></div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="logStopModal">
  <div class="modal-box">
    <div class="card-title" id="modalClientName">Log Stop</div>
    <div class="form-group">
      <label>Invoice Total ($)</label>
      <input type="number" id="m_invoice" step="0.01">
    </div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
        <div class="form-group"><label>Checks/AR</label><input type="number" id="m_checks" step="0.01"></div>
        <div class="form-group"><label>Cash</label><input type="number" id="m_cash" step="0.01"></div>
    </div>
    <button class="btn btn-green" onclick="completeStop()">Complete & Log</button>
    <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
  </div>
</div>

<div id="toast"></div>

<script>
// 1. CONFIGURATION (REPLACE THESE)
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT-default-rtdb.firebaseio.com",
  projectId: "YOUR_PROJECT",
  appId: "YOUR_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// 2. PAYROLL LOGIC (EXACT CONTRACT TIERS)
const TIERS = [
  { min: 0,    max: 6999,  pct: 25.0 },
  { min: 7000, max: 7499,  pct: 27.5 },
  { min: 7500, max: 7999,  pct: 30.0 },
  { min: 8000, max: 8499,  pct: 32.5 },
  { min: 8500, max: 8999,  pct: 35.5 },
  { min: 9000, max: 9749,  pct: 38.0 },
  { min: 9750, max: 99999, pct: 40.0 }
];

let rosterData = {};
let liveRoute = {};
let currentStopKey = null;

// 3. CORE FUNCTIONS
function setRole(role) {
  document.getElementById('btnDriver').classList.toggle('active', role === 'driver');
  document.getElementById('btnBoss').classList.toggle('active', role === 'boss');
  document.getElementById('tab-dispatch').classList.toggle('hidden', role !== 'boss');
  showTab(role === 'boss' ? 'dispatch' : 'route');
}

function showTab(tab) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + tab).classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
}

// Firebase Listeners
db.ref('roster').on('value', snap => {
  rosterData = snap.val() || {};
  renderRoster();
  renderDispatchList();
});

db.ref('live_route').on('value', snap => {
  liveRoute = snap.val() || {};
  renderLiveRoute();
});

db.ref('payroll_logs').on('value', snap => {
  calculatePayroll(snap.val() || {});
});

function saveClient() {
  const name = document.getElementById('r_name').value;
  if(!name) return;
  db.ref('roster').push({
    name: name,
    address: document.getElementById('r_address').value,
    terms: document.getElementById('r_terms').value
  });
  toast("Client Added");
}

function dispatchRoute() {
  const selected = {};
  document.querySelectorAll('.dispatch-check:checked').forEach(cb => {
    selected[cb.value] = true;
  });
  db.ref('live_route').set(selected);
  toast("Route Dispatched!");
}

function openStop(key) {
  currentStopKey = key;
  document.getElementById('modalClientName').innerText = rosterData[key].name;
  document.getElementById('logStopModal').classList.add('active');
}

function completeStop() {
  const inv = parseFloat(document.getElementById('m_invoice').value) || 0;
  db.ref('payroll_logs').push({
    amount: inv,
    cash: parseFloat(document.getElementById('m_cash').value) || 0,
    checks: parseFloat(document.getElementById('m_checks').value) || 0,
    client: rosterData[currentStopKey].name,
    timestamp: Date.now()
  });
  db.ref('live_route/' + currentStopKey).remove();
  closeModal();
}

function calculatePayroll(logs) {
  let totalSales = 0;
  Object.values(logs).forEach(l => totalSales += l.amount);
  
  let pct = 25;
  TIERS.forEach(t => { if(totalSales >= t.min) pct = t.pct; });
  
  const commission = totalSales * (pct / 100);
  const totalPay = 600 + commission;
  
  document.getElementById('paycheck').innerText = "$" + totalPay.toFixed(2);
  document.getElementById('payrollStats').innerText = `Sales: $${totalSales.toFixed(2)} | Tier: ${pct}%`;
  renderTierTable(pct);
}

// Helpers
function closeModal() { document.getElementById('logStopModal').classList.remove('active'); }
function toast(msg) { 
  const t = document.getElementById('toast');
  t.innerText = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

function renderRoster() {
    const el = document.getElementById('rosterList');
    el.innerHTML = Object.keys(rosterData).map(k => `
        <div class="card">${rosterData[k].name} <span class="badge badge-ar">${rosterData[k].terms}</span></div>
    `).join('');
}

function renderDispatchList() {
    const el = document.getElementById('dispatchChecklist');
    el.innerHTML = Object.keys(rosterData).map(k => `
        <div class="dispatch-check-item">
            <input type="checkbox" class="dispatch-check" value="${k}">
            <label>${rosterData[k].name}</label>
        </div>
    `).join('');
}

function renderLiveRoute() {
    const el = document.getElementById('liveRouteList');
    el.innerHTML = Object.keys(liveRoute).map(k => {
        const client = rosterData[k] || {name: "Unknown"};
        return `<div class="card" onclick="openStop('${k}')">üìç ${client.name}</div>`;
    }).join('');
}

function renderTierTable(activePct) {
    const el = document.getElementById('tierTable');
    el.innerHTML = TIERS.map(t => `
        <div class="tier-row ${t.pct === activePct ? 'active-tier' : ''}">
            <span>$${t.min}+</span> <span>${t.pct}%</span>
        </div>
    `).join('');
}

function translateTyped(from, to) {
    const text = document.getElementById('typeInput').value;
    fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|es`)
    .then(r => r.json()).then(d => {
        document.getElementById('translationDisplay').innerText = d.responseData.translatedText;
    });
}

function initPlacesAutocomplete() {} // Placeholder for script callback
</script>
</body>
</html>
